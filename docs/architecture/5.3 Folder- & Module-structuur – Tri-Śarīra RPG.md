# 5.3 Folder- & Module-structuur – Tri-Śarīra RPG

**Versie:** 0.1  
**Auteur:** Gerald (met Architect- & Game Designer-ondersteuning)  
**Status:** Voorstel folder- & module-layout. Richtlijn voor Codex/Claude en voor jezelf.

Doel:

- Eén **heldere, stabiele projectstructuur** neerzetten voor de gamecode, data, maps en tools.  
- Aansluiten op 5.1 Tech Overview, 5.2 Code-architectuur en de 3.x / 4.x systems- & dataspecs.  
- Vertical slice eerst, maar direct schaalbaar naar volledige game + trilogie.

---

## 1. Top-level structuur

Projectroot (voorbeeld):

```text
tri_sarira_rpg/
├─ src/
├─ data/
├─ schema/
├─ maps/
├─ assets/
├─ config/
├─ tools/
├─ tests/
├─ scripts/
├─ .venv/              (lokaal, niet in repo committen)
├─ pyproject.toml
├─ README.md
├─ CHANGELOG.md
└─ LICENSE (later)
```

Kernidee:

- **`src/`** – alle Python-code (game, engine, systems).  
- **`data/`** – JSON-content voor actors, items, quests, etc.  
- **`schema/`** – JSON Schema-bestanden (`*.schema.json`).  
- **`maps/`** – Tiled `.tmx`-files, 1 per zone.  
- **`assets/`** – sprites, tilesets, audio.  
- **`config/`** – TOML-configs voor game/engine.  
- **`tools/`** – losse Python-scripts (data-validatie, buildhelpers).  
- **`tests/`** – pytest-tests voor systems en tools.  
- **`scripts/`** – shell/PowerShell helpers (run, build, lint, etc.).

---

## 2. `src/` – code-hiërarchie

```text
src/
└─ tri_sarira_rpg/
   ├─ __init__.py
   ├─ app/           # Game loop, bootstrap, entry point
   ├─ core/          # Protocols, scene management, config, entities
   ├─ systems/       # Game logic (combat, party, quests, dialogue, etc.)
   ├─ services/      # Facades/services (GameDataService)
   ├─ data_access/   # Data loading (Loader, Repository, Cache)
   ├─ presentation/  # Scenes, UI components, theming
   └─ utils/         # Helpers (tiled loader, math, debug)
```

### 2.1 `src/tri_sarira_rpg/app/`

```text
src/tri_sarira_rpg/app/
├─ __init__.py
├─ game.py           # Game-klasse, main-loop, bootstrap
├─ main.py           # entrypoint (if __name__ == "__main__")
└─ version.py        # versie-info, build_id
```

- `game.py` initialiseert Pygame, Config, ResourceManager, DataRepository, systems en SceneManager.  
- `main.py` is klein en roept alleen `Game().run()` aan.

### 2.2 `src/tri_sarira_rpg/core/`

```text
src/tri_sarira_rpg/core/
├─ __init__.py
├─ config.py         # Config-laag (TOML inlezen, env overrides)
├─ scene.py          # Scene baseclass, SceneManagerProtocol, SceneStackManager
├─ protocols.py      # Protocol-based interfaces voor alle systems (DI)
├─ entities.py       # Basis dataclasses (Entity, Position)
├─ events.py         # Event definities
├─ game_state.py     # Global game state container
├─ resources.py      # Resource paths
├─ timing.py         # FPS, delta-time helpers
└─ logging_setup.py  # logging-config (dev/release)
```

**Belangrijke modules:**
- `protocols.py` – Definieert alle SystemProtocols voor loose coupling (zie 5.2 sectie 3.3)
- `scene.py` – SceneManagerProtocol interface + SceneStackManager implementatie
- Geen game-content in `core/`, alleen generieke infrastructuur.

### 2.3 `src/tri_sarira_rpg/systems/`

```text
src/tri_sarira_rpg/systems/
├─ __init__.py
├─ world.py              # WorldSystem, zone/tiles, portals, encounters
├─ combat.py             # CombatSystem, battlecontext, damage, status
├─ combat_viewmodels.py  # Immutable viewmodels voor combat UI (BattleStateView, etc.)
├─ party.py              # PartySystem, actor-state koppeling
├─ quest.py              # QuestSystem, quest-state-machine, rewards
├─ dialogue.py           # DialogueSystem, graph-evaluatie, conditions/effects
├─ dialogue_viewmodels.py # Immutable viewmodels voor dialogue UI
├─ time.py               # TimeSystem, dag/nacht, seizoenen
├─ inventory.py          # InventorySystem, item storage
├─ equipment.py          # EquipmentSystem, gear slots, stat bonuses
├─ shop.py               # ShopSystem, buy/sell, currency management
├─ economy.py            # EconomySystem (stub, currency in ShopSystem)
├─ progression.py        # ProgressionSystem, XP/level-ups, Tri-profielen
├─ save.py               # SaveSystem, SaveData build/load
├─ state.py              # GameStateFlags, globale flags, choice-history
└─ items.py              # ItemsSystem (stub voor item effects)
```

**Architectuurprincipes:**
- Elk systeem is **Pygame-onafhankelijk** (pure Python logica)
- Systems implementeren hun Protocol uit `core/protocols.py`
- ViewModels (`*_viewmodels.py`) leveren immutable snapshots aan de UI
- `state.py` bevat `GameStateFlags` voor story flags en choice history

### 2.4 `src/tri_sarira_rpg/data_access/`

```text
src/tri_sarira_rpg/data_access/
├─ __init__.py
├─ repository.py     # DataRepository: toegang tot JSON-content
├─ loader.py         # Bestands-I/O, JSON-parsing
├─ cache.py          # Eenvoudige caches (optioneel)
└─ ids.py            # Centralisatie van type-aliases / ID-typen (optioneel)
```

- `DataRepository` bevat functies als `get_actor`, `get_quest`, `get_dialogue`, etc.
- Schema-validatie gebeurt primair via `tools/` (offline), niet in runtime.

### 2.5 `src/tri_sarira_rpg/services/`

```text
src/tri_sarira_rpg/services/
├─ __init__.py
└─ game_data.py      # GameDataService - UI facade met typed view models
```

**`GameDataService`** fungeert als facade tussen presentation en data_access:
- Biedt typed view models (`ItemDisplayInfo`, `SkillDisplayInfo`, `EnemyDisplayInfo`)
- UI componenten hoeven geen raw dicts te parsen
- Centraal punt voor data transformatie naar UI-vriendelijke structuren

### 2.6 `src/tri_sarira_rpg/presentation/`

```text
src/tri_sarira_rpg/presentation/
├─ __init__.py
├─ overworld.py      # OverworldScene, rendering van map + entities
├─ battle.py         # BattleScene, battle UI
├─ main_menu.py      # MainMenuScene
├─ pause_menu.py     # Pause/menu overlays
├─ theme.py          # UI theming (Colors, Fonts, ThemeProvider)
└─ ui/
   ├─ __init__.py
   ├─ widgets.py     # Base Widget, Container classes
   ├─ menus.py       # Menu component voor list selection
   ├─ dialogue_box.py# Dialogue rendering
   ├─ hud.py         # Heads-up display (party info, stats, time)
   ├─ quest_log.py   # Quest log UI
   ├─ shop_menu.py   # Shop interface UI
   ├─ equipment_menu.py # Equipment/gear UI
   └─ pause_menu.py  # Pause menu UI overlay
```

**Architectuurprincipes:**
- Scenes liggen hier (in lijn met 5.2)
- `theme.py` bevat alle UI styling (Colors, FontSizes, Spacing, ThemeProviderProtocol)
- UI-componenten in `presentation/ui/` worden door meerdere scenes gedeeld
- UI componenten consumeren alleen ViewModels, geen directe system state

### 2.7 `src/tri_sarira_rpg/utils/`

```text
src/tri_sarira_rpg/utils/
├─ __init__.py
├─ tiled_loader.py   # Tiled TMX map parsing
├─ math_helpers.py
├─ typing_helpers.py
├─ profiler.py       # Eenvoudige profiler-hooks, optioneel
└─ debug.py          # Debughelpers (bv. overlays togglen)
```

- Kleine, herbruikbare hulpfuncties, NIET game-content.
- `tiled_loader.py` voor TMX map loading en collision detection.

---

## 3. `data/` – gamecontent

```text
data/
├─ actors.json
├─ enemies.json
├─ items.json
├─ skills.json
├─ quests.json
├─ dialogue.json
├─ npc_schedules.json
├─ events.json
├─ shops.json
├─ loot_tables.json
├─ chests.json
├─ zones.json
└─ examples/
   ├─ actors_example.json
   ├─ enemies_example.json
   ├─ items_example.json
   ├─ skills_example.json
   ├─ quests_example.json
   ├─ dialogue_example.json
   ├─ npc_schedules_example.json
   ├─ events_example.json
   ├─ shops_example.json
   ├─ loot_tables_example.json
   ├─ chests_example.json
   └─ savegame_example.json
```

- `*_example.json` dienen als **voorbeeld en testinput**; vertical slice-data kan direct vanuit deze startpunten worden opgebouwd.  
- `zones.json` geeft een overzicht van alle zones (id, naam, recommended_level, enz.) en moet synchroon lopen met `maps/*.tmx`.

Later kun je subfolders introduceren (bv. `data/r1/actors_r1.json`), maar v0.1 houdt het vlak en overzichtelijk.

---

## 4. `schema/` – JSON Schema’s

```text
schema/
├─ actors.schema.json
├─ enemies.schema.json
├─ items.schema.json
├─ skills.schema.json
├─ quests.schema.json
├─ dialogue.schema.json
├─ npc_schedules.schema.json
├─ events.schema.json
├─ savegame.schema.json
├─ shops.schema.json
├─ loot_tables.schema.json
└─ chests.schema.json
```

- In lijn met **4.1 JSON-schema’s – Overzicht per type**.  
- Worden primair gebruikt door tools in `tools/validation/`.

---

## 5. `maps/` – Tiled-zones

```text
maps/
├─ z_r1_chandrapur_town.tmx
├─ z_r1_training_ground.tmx
├─ z_r1_forest_route.tmx
├─ z_r1_shrine_clearing.tmx
└─ z_r1_shrine_inner.tmx
```

- 1 map per **zone**; bestandsnaam = `zone_id` + `.tmx`.  
- Tilesets worden extern in `assets/tilesets/` gedefinieerd.

Voor toekomstige regio’s:

```text
maps/
├─ r1/
│  ├─ z_r1_chandrapur_town.tmx
│  └─ ...
├─ r2/
│  ├─ z_r2_*.tmx
│  └─ ...
└─ ...
```

Structureren per regio mag, zolang de **bestandsnamen** consistent blijven.

---

## 6. `assets/` – art & audio

```text
assets/
├─ sprites/
│  ├─ characters/
│  │  ├─ mc_adhira.png
│  │  ├─ comp_rajani.png
│  │  └─ ...
│  ├─ enemies/
│  │  ├─ en_forest_sprout.png
│  │  └─ en_shrine_guardian.png
│  └─ ui/
│     ├─ frame_window.png
│     └─ icons.png
├─ tilesets/
│  ├─ ts_town_basic.tsx
│  ├─ ts_forest_r1.tsx
│  └─ ts_interior_wood.tsx
└─ audio/
   ├─ bgm/
   │  ├─ r1_chandrapur_town.ogg
   │  └─ r1_forest_route.ogg
   └─ sfx/
      ├─ ui_confirm.wav
      ├─ hit_basic.wav
      └─ chest_open.wav
```

- Geen logica hier, alleen **resources** die via `ResourceManager` geladen worden.

---

## 7. `config/` – instellingen

```text
config/
├─ default_config.toml
└─ dev.toml
```

- `default_config.toml` – standaardinstellingen (resolutie, fullscreen, volume, keybinds).  
- `dev.toml` – overrides voor ontwikkelomgeving (debug flags, skip intro, loglevel).  
- In code geladen door `core.config.Config`.

---

## 8. `tools/` – dev-tools & scripts

```text
tools/
├─ __init__.py
├─ validate_data.py       # JSON Schema-validatie + referentie-checks
├─ dump_ids.py            # Overzicht van alle IDs (actors, quests, zones, ...)
├─ generate_stub_data.py  # Optioneel: maken van stub-data
└─ tiled/
   ├─ __init__.py
   └─ export_zones.py     # Tools om maps-info te extraheren, optioneel
```

- `validate_data.py` is belangrijk: wordt in build/test pipeline gebruikt om data te checken.  
- `tiled/`-subfolder kan scripts bevatten om uit `.tmx` metadata te exporteren en te vergelijken met `zones.json`.

---

## 9. `tests/` – pytest-structuur

```text
tests/
├─ __init__.py
├─ test_combat_system.py
├─ test_quest_system.py
├─ test_save_roundtrip.py
└─ test_data_validation.py
```

- Testen richten zich eerst op systems (combat, quests, save/load).  
- `test_data_validation.py` kan `tools.validate_data` aanroepen of direct schema’s laden.

Later kun je subfolders maken (`tests/systems/`, `tests/tools/`) als het groeit.

---

## 10. `scripts/` – run & build helpers

```text
scripts/
├─ run_dev.ps1          # Windows/PowerShell: dev-run
├─ run_dev.sh           # Unix/WSL: dev-run
├─ run_tests.ps1
├─ run_tests.sh
├─ format.ps1           # black/ruff
├─ format.sh
└─ build_dist.ps1       # later: pyinstaller / zip
```

- Niet verplicht, maar **erg handig** voor jouw workflow met WSL + Windows.  
- Deze scripts roepen gewoon `python -m tri_sarira_rpg.app.main`, `pytest`, etc. aan.

---

## 11. Vertical Slice – minimale mappen/bestanden

Voor A2 (vertical slice) moeten minimaal bestaan:

- `src/tri_sarira_rpg/app/game.py`, `app/main.py`  
- `src/tri_sarira_rpg/core/config.py`, `core/scene.py`, `core/resources.py`, `core/logging_setup.py`  
- `src/tri_sarira_rpg/systems/world.py`, `combat.py`, `party.py`, `quests.py`, `dialogue.py`, `time.py`, `items.py`, `economy.py`, `progression.py`, `save.py` (evt. deels stub).  
- `src/tri_sarira_rpg/data_access/repository.py`, `loader.py`  
- `src/tri_sarira_rpg/presentation/overworld.py`, `battle.py`, `main_menu.py`, `presentation/ui/dialogue_box.py`, `presentation/ui/widgets.py`  
- `data/*.json` voor actors, enemies, items, skills, quests, dialogue, npc_schedules, events, shops, loot_tables, chests, zones (minimaal R1).  
- `maps/z_r1_chandrapur_town.tmx`, `z_r1_forest_route.tmx`, `z_r1_shrine_clearing.tmx`  
- `schema/*.schema.json` als basis (hoeft nog niet allemaal used-in-code te zijn).  
- `tools/validate_data.py` (basic versie).  
- `config/default_config.toml` + `config/dev.toml` (basic).

Met deze structuur kan Codex/Claude **zonder discussie** nieuwe modules aanmaken en weet jij altijd waar iets hoort te liggen.

---

## 12. Relatie met andere artefacten

- Sluit direct aan op **5.1 Tech Overview** en **5.2 Code Architectuur-overzicht**.  
- 3.x systems-specs geven per systeem aan welke modules/classes binnen `src/tri_sarira_rpg/systems/` belangrijk zijn.  
- 4.x data/specs sturen de inhoud van `data/` en `schema/`.  
- 4.3 Tiled Conventions bepaalt hoe `maps/` en `assets/tilesets/` gevuld worden.

Versie 0.1 is **bewust concreet maar niet verstikkend**: structuur ligt vast, maar de exacte klassennamen en interne submodules kunnen tijdens implementatie verder uitgewerkt worden.
