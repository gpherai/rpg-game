# 3.4 Quests & Dialogue System Spec – Tri-Śarīra RPG

**Versie:** 0.1  
**Auteur:** Gerald (met Game Designer- & Architect-ondersteuning)  
**Status:** Design-spec. Richt de logica in achter quests, dialogue, branching en conditions.

---

## 1. Doel & scope

Dit document beschrijft **hoe quests en dialogen als systemen werken**:

- Hoe een **quest** is opgebouwd (states, stages, branching, rewards).  
- Hoe **dialogue** is gemodelleerd (nodes, keuzes, conditions, effecten).  
- Hoe quests & dialogue samenwerken met **flags**, **tijd**, **party/NPC-fasen** en **Tri-Śarīra**.  
- Welke subset nodig is voor de **vertical slice**, en wat later volgt.

Het is een **engine-onafhankelijke designlaag**, met JSON in gedachten als datadrager en Python/Pygame als runtime.

Bouwt voort op:

- **2.4 Quest Taxonomy & Voorbeeldlijst** – *wat* voor quests er zijn.  
- **2.1 World & Regions Overview** – waar quests zich afspelen.  
- **2.2 Kalender & Festivals Spec** – tijd & events.  
- **2.3 NPC Cast & Fasen** – wie quests draagt.  
- **3.1 Combat & Stats Spec** – combat-gerelateerde quest-conditions/rewards.  
- **3.2 Time, World & Overworld Spec** – zones, encounters.  
- **3.3 NPC & Party System Spec** – companion-conditions en missables.

---

## 2. Designprincipes

1. **Data-gedreven, niet hard-coded**  
   Quest- en dialogestructuur zit in JSON; de engine voert alleen regels uit en evalueert conditions.

2. **Kleine kern, veel expressie**  
   Een beperkt aantal condition- en effecttypes, maar combineerbaar om veel soorten quests te bouwen.

3. **Leesbaar voor speler**  
   - Questlog is duidelijk: wat doe ik nu, wat heb ik gedaan, wat is mislukt.  
   - Essentiële hints zijn terugleesbaar (herhaalbare dialogen, context-hints).

4. **Tri-Śarīra door de systemen heen**  
   Quests en dialogen kunnen Body/Mind/Spirit-checks doen en rewards geven die daar naar terugverwijzen.

5. **Missables mogen, maar niet softlocken**  
   Quest- en dialoguebranching mag content missable maken, maar niet de hoofdverhaallijn blijvend blokkeren.

---

## 3. Quest-systeem – conceptueel model

### 3.1 Kernbegrippen

- **Quest** – een gestructureerde taak met stages en uitkomsten.  
- **Stage** – een stap binnen een quest ("praat met X", "ga naar Y", "versla Z").  
- **State** – overall status van een quest (bijv. ACTIEF, VOLTOOID, MISLUKT).  
- **Condition** – logische check (flags, tijd, stats, etc.).  
- **Effect** – wat er gebeurt bij het voltooien van een stage of quest (xp, items, flags, world changes).

### 3.2 Quest lifecycle & states

Per quest hanteren we een eenvoudige state-machine:

- `NOT_DISCOVERED` – speler kent quest niet (nog geen entry in log).  
- `DISCOVERED` – speler heeft de hook gezien (bv. gerucht, object), maar nog niet accepted (optioneel).  
- `ACTIVE` – quest is aangenomen en heeft een current stage.  
- `COMPLETED_SUCCESS` – met succes afgerond.  
- `COMPLETED_FAIL` – mislukt door keuze/fout.  
- `EXPIRED` – niet meer beschikbaar door tijd/event (tijdgebonden missable).  
- `ABANDONED` – bewust gestopt (optioneel feature, later).

In de vertical slice zijn `ACTIVE`, `COMPLETED_SUCCESS` en `NOT_DISCOVERED` voldoende; `FAIL/EXPIRED` zijn alvast meegenomen voor toekomst.

### 3.3 Queststructuur (designlaag)

Per quest:

- `quest_id` – uniek.  
- `title` – schermnaam.  
- `quest_type` – MSQ/TTQ/CQ/RQ/FQ/PGQ (zie 2.4).  
- `region_id` – waar quest primair thuishoort.  
- `tri_focus_primary` / `tri_focus_secondary` – Body/Mind/Spirit-labels.  
- `giver_npc_id` – hoofd-NPC (optioneel).  
- `required_flags` / `forbidden_flags` – voor start.  
- `time_window` – optioneel (seizoen, dag, festival).  
- `stages` – array van Stage-definities.  
- `rewards` – basisrewards bij `COMPLETED_SUCCESS`.

### 3.4 Stage-structuur

Per stage:

- `stage_id` – binnen quest.  
- `description` – voor questlog.  
- `objectives` – lijst van doelen (bijv. praat met X, reach zone Y).  
- `auto_advance` – bool (bij true: zodra objectives klaar → volgende stage).  
- `next_on_success` – volgende stage-id of direkte quest-state-change.  
- `next_on_fail` – optioneel; voor branch/fail-route.  
- `enter_effects` – effecten bij het in deze stage komen.  
- `complete_effects` – effecten bij het afronden van deze stage.

**Objectives** kunnen standaardsjablonen gebruiken, zoals:

- `TALK_TO_NPC` – bereik een dialoog-node.  
- `REACH_ZONE` – betreed een zone/locatie.  
- `DEFEAT_ENEMY_GROUP` – win battle tegen specifieke groep/boss.  
- `COLLECT_ITEM` – verkrijg X van item Y.  
- `WAIT_UNTIL_TIME` – tijdscheck (seizoen/feest).  
- `CUSTOM_FLAG` – een willekeurige flagconditie.

De engine heeft generieke evaluators voor deze objective-types.

---

## 4. Dialogue-systeem – conceptueel model

### 4.1 Kernbegrippen

- **DialogueNode** – één scherm/tekstblok in gesprek.  
- **Line** – een zin/regel tekst van een spreker. (Voor v1: 1–3 regels per node.)  
- **Choice** – speleropties vanuit een node.  
- **Branch** – welke node volgt, afhankelijk van keuze/conditions.  
- **DialogueGraph** – verzameling nodes per NPC, scene of quest.

### 4.2 DialogueNode-structuur

Per node (conceptueel):

- `node_id`  
- `speaker_id` – NPC of `PLAYER`.  
- `lines` – array van tekstregels (met evt. emotie-tags).  
- `choices` – optionele array van Choice-definities.  
- `auto_advance_to` – optioneel: volgende node-id bij geen keuzes.  
- `conditions` – optioneel: node alleen beschikbaar als condities waar zijn.  
- `once_per_save` / `once_per_day` – limitering van herhaling.

### 4.3 Choice-structuur

Per keuze:

- `choice_id`  
- `text` – optie-tekst in de UI.  
- `conditions` – optionele voorwaarden (flags, stats, companion aanwezig, etc.).  
- `effects` – flags, quest-stage-updates, rewards, karma-aanpassing, etc.  
- `next_node_id` – welke node volgt.  
- Optioneel: `end_conversation` – bool.

### 4.4 Dialogue & quests

Dialogues zijn de voornaamste manier om:

- quests te **starten, updaten of afronden**,  
- NPC-fase-transities te triggeren (Ontmoeting → Metgezel → Vestiging),  
- hints & lore aan te bieden.

Dit gebeurt via **effecten** in dialogue nodes/choices:

- `quest_start(quest_id)`  
- `quest_advance(quest_id, new_stage_id)`  
- `quest_complete_success(quest_id)`  
- `quest_complete_fail(quest_id)`  
- `set_flag(flag_id)` / `clear_flag(flag_id)`  
- `add_item(item_id, amount)`  
- etc.

---

## 5. Conditions & effecten – types

### 5.1 Condition-types

Veelgebruikte conditioncategorieën:

1. **Story & quest**  
   - `flag_set(flag_id)` / `flag_not_set(flag_id)`  
   - `quest_state(quest_id) == ACTIVE/COMPLETED/...`  
   - `quest_stage(quest_id) == X`

2. **Tijd & kalender**  
   - `time_band == DAY/NIGHT/...`  
   - `season_index == X`  
   - `day_index` in range (voor unieke events)  
   - `is_festival(festival_id)`

3. **Locatie & zone**  
   - `current_zone_id == Z`  
   - `near_object(object_id)` (bij interactie)

4. **Party & NPC-fase**  
   - `companion_in_party(npc_id)`  
   - `npc_phase(npc_id) == SEED/COMPANION/SETTLED/...`  
   - `npc_recruited(npc_id)`

5. **Stats & Tri-Śarīra** (voor checks & varianten)  
   - `BodyScore >= N`  
   - `MindScore >= N`  
   - `SpiritScore >= N`  
   - of checks op individuele stats zoals STR/FOC/MAG.

6. **Karma & belangrijke keuzes**  
   - `karma_axis_X >= N` (later, wanneer karmasysteem concreet is).  
   - `choice_history` (heb je ooit optie Y gekozen?).

Vertical slice: vooral story/quest/locatie-conditions + 1–2 simpele tijd- of partychecks.

### 5.2 Effecttypes

Basis-effecten:

- **Flags**  
  - `set_flag(id)` / `clear_flag(id)`

- **Quest**  
  - `quest_start(id)`  
  - `quest_advance(id, stage)`  
  - `quest_complete_success(id)` / `quest_complete_fail(id)`

- **Items & resources**  
  - `give_item(id, amount)`  
  - `modify_money(amount)`  
  - `modify_xp(amount or per-character)`

- **Stats & Tri-Śarīra**  
  - `modify_body/mind/spirit(delta)`  
  - `modify_stat(STR/FOC/MAG/...)` (voor uitzonderingen of rituele rewards)

- **Party & NPC**  
  - `add_companion(npc_id)` / `remove_companion(npc_id)`  
  - `set_npc_phase(npc_id, phase)`  
  - `move_npc_to_zone(npc_id, zone_id)`

- **World changes**  
  - `unlock_zone(zone_id)`  
  - `open_portal(portal_id)` / `close_portal(portal_id)`  
  - `set_environment_state(id)` (bijv. shrine_restored).

Complexere effecten (cutscenes, teleport, multi-step events) worden in `events.json` beschreven en door Scenes & State Flow aangeroepen.

---

## 6. Questlog & UI

### 6.1 Structuur in UI

- **Tabs of filters** per quest_type (Main, Companion, Region, Festival, Post-game).  
- Voor elke quest:
  - titel, regio, type, Tri-tag.  
  - huidige stagebeschrijving + 1–2 vorige stappen (short history).  
  - status: Actief / Voltooid / Mislukt / Verlopen.

### 6.2 QoL-richtlijnen

- Actieve MSQ **bovenaan**.  
- Belangrijke hints uit dialogue komen in **logboekvorm** (herleesbaar).  
- Geen overvolle objective-lijst; liever korte, heldere zinnen.  
- Bij tijdgebonden quests: duidelijke tekst dat het tijdgebonden is (zonder exacte minuten te tonen, tenzij nodig).

Vertical slice:  

- Eén simpele questlog-view (lijst + detailscherm) is voldoende.

---

## 7. Integratie met Scenes & State Flow

### 7.1 Waar wordt wat geëvalueerd?

- **OverworldScene**  
  - checkt movement-gerelateerde objectives (REACH_ZONE, encounter-start, etc.).  
  - registreert interacties met objects (borden, shrines).

- **DialogueSystem** (binnen OverworldScene)  
  - evalueert `conditions` per node/choice.  
  - voert `effects` uit (flags, quest-updates, companions, items).

- **BattleScene**  
  - informeert QuestSystem over battle-uitkomsten (DEFEAT_ENEMY_GROUP objective).  
  - kan speciale battle-flags zetten (bijv. bepaalde enemy gespaard vs gedood).

- **Event/Cutscene Runner**  
  - speelt scripted sequences die meerdere systems tegelijk beïnvloeden (tijdskip, teleport, multi-NPC-moves).

### 7.2 Flow van een typische quest-update

1. Speler start dialoog → DialogueSystem kiest juiste node (conditions).  
2. Speler kiest optie → effects: `quest_start` of `quest_advance`.  
3. QuestSystem verandert `quest_state` en `current_stage`.  
4. Overworld/Battle/Event-systems zorgen dat objectives van deze nieuwe stage geobserveerd worden.  
5. Bij voldane objectives (en evt. trigger via dialoog) → `quest_advance` naar volgende stage of `complete`.

---

## 8. Vertical Slice vs. volledige game

### 8.1 Vertical Slice – minimale set

Voor M2 (vertical slice) is nodig:

- **QuestSystem v0** met:
  - 3–5 quests (incl. 1 MSQ, 1–2 RQ, 1 CQ light).  
  - States: ACTIVE, COMPLETED_SUCCESS.  
  - Stages met simpele objectives (TALK_TO_NPC, REACH_ZONE, DEFEAT_ENEMY_GROUP).  
- **DialogueSystem v0** met:
  - Node → Choice → Node-structuur.  
  - Basisconditions: `flag_set`, `quest_state`, `companion_in_party` (optioneel).  
  - Basis effects: `set_flag`, `quest_start/advance/complete`, `give_item`.

UI:

- Eenvoudige questlog met lijst + detail.  
- Dialoogscherm met portret (later), naam en tekst, en opties.

### 8.2 Latere uitbreiding

Volgende milestones kunnen toevoegen:

- Volledige state-machine (FAIL/EXPIRED/ABANDONED).  
- Tijd- en seizoensconditions, festivalquests.  
- Complexere branches (multi-endings per quest).  
- Karma-conditions en -effects.  
- Dialogue-historie, scrollback, voice- of sound-tags.

De nu gedefinieerde structuren zijn vooruit-compatibel: we voegen types en velden toe zonder bestaande data te breken.

---

## 9. Data & schema’s

Belangrijke bestanden:

- **`quests.schema.json`** – definieert questvelden, stages, objectives, rewards.  
- **`quests.json`** – concrete questdata per regio/hoofdstuk.  
- **`dialogue.schema.json`** – definieert DialogueGraph/Node/Choice.  
- **`dialogue_*.json`** – per NPC, regio of chapter aparte bestanden.  
- **`events.schema.json` / `events.json`** – voor complexere event chains.

`savegame.schema.json` bevat onder andere:

- `quests`: map `quest_id -> { state, current_stage, custom_data }`.  
- `flags`: set/list van globale flags.  
- `karma` en andere meta-variabelen.

---

## 10. Relatie met andere artefacten

- **2.4 Quest Taxonomy & Voorbeeldlijst** – definieert questtypen en concrete voorbeelden waarop deze systeemlaag toegepast wordt.  
- **2.3 NPC Cast & Fasen** – bepaalt welke NPC’s key questgivers zijn en welke companion-arcs er zijn.  
- **2.2 Kalender & Festivals Spec** – levert tijd- en eventconditions voor quests en dialogue.  
- **3.1 Combat & Stats Spec** – levert statnames en combat-resultaten die kunnen worden gebruikt als objectives/conditions.  
- **3.2 Time, World & Overworld Spec** – levert zones, encounters en portals die als objectives/conditions fungeren.  
- **4.x Data & Schema’s** – implementeren de JSON-structuren waar deze spec naar verwijst.

Versie 0.1 legt de **logische ruggengraat** vast van quests en dialogue. Balancing, concrete verhaallijnen en tekstuele invulling komen daarna; dit document waarborgt dat alles op één consistente, data-gedreven manier werkt.

