# 3.8 Save & Trilogy Continuity Spec – Tri-Śarīra RPG

**Versie:** 0.1  
**Auteur:** Gerald (met Game Designer- & Architect-ondersteuning)  
**Status:** Design-spec. Richt de save-structuur in en bepaalt welke data doorloopt naar deel 2 en 3.

---

## 1. Doel & scope

Dit document beschrijft **hoe de game-state wordt opgeslagen** en **welke delen daarvan trilogie-bewust zijn**:

- Structuur van **saveslots** en savebestanden.  
- Welke **systemen in de save** terechtkomen (wereld, tijd, player, party, quests, NPC’s, items, etc.).  
- Hoe **post-game** en **NG+** flags worden opgeslagen.  
- Hoe een **Trilogy Export** eruitziet: een samengevat profiel dat door deel 2/3 kan worden ingelezen.

Het is een engine-onafhankelijke designlaag (JSON als uitgangspunt), afgestemd op:

- **Scenes & State Flow** – welke scene welke state beheert.  
- **3.x Systems Specs** – combat, overworld, party, quests, progression, items, post-game.  
- **3.7 Post-game & NG+ Spec** – clear flags, NG+ loops.

---

## 2. Designprincipes

1. **Één bron van waarheid per systeem**  
   Savegame weerspiegelt de echte runtime-state; geen dubbele representaties.

2. **Stabiel & uitbreidbaar**  
   Nieuwe velden kunnen toegevoegd worden zonder oude saves te breken; verouderde velden kunnen genegeerd worden.

3. **Trilogie-bewust**  
   Belangrijke keuzes, progression en resultaten worden expliciet vastgelegd zodat deel 2 en 3 ze betrouwbaar kunnen lezen.

4. **Veilig & robuust**  
   Basale integriteitschecks (checksum, versie) en duidelijke foutafhandeling bij laden.

5. **Leesbaar voor tooling**  
   Structuur is eenvoudig genoeg om door externe tools (debug, migratie, analysetools) gelezen te worden.

---

## 3. Save-model – overzicht

### 3.1 Save slots & meta

Conceptueel heeft het spel:

- **Profiel-niveau** (optioneel): meerdere playerprofielen op één systeem.  
- **Save slots** per profiel: b.v. 3–5 manual saves + 1 auto-save.

Per slot zijn er twee lagen:

1. **Save Meta** – klein stukje data voor save-selectiescherm:
   - `slot_id`  
   - `profile_id`  
   - `save_label` (optionele custom naam)  
   - `created_at`, `updated_at` (timestamps)  
   - `play_time` (totale speeltijd)  
   - `chapter_id` / main story progress-indicator  
   - `zone_id` + korte zone-naam  
   - `player_level` (protagonist)  
   - `flags`: `is_postgame`, `is_ngplus`, `clear_count`.

2. **Save Data** – volledige game-state (zie §4).

### 3.2 Save momenten

Hoofdmodellen:

- **Manual save** – op specifieke plekken (inns, shrines, Circle of Companions, sommige dungeonsaves).  
- **Auto-save** – bij kritieke events (zone-overgangen, einde gevecht tegen bosses, belangrijke quest-updates).  
- **Quick save** (optioneel, later) – tijdelijke sessie-save.

Vertical slice: manual + eenvoudige auto-save (bv. voor boss fights / slice-finales) is voldoende.

### 3.3 Versiebeheer & integriteit

Top-level velden:

- `schema_version` – integer of semver-string (b.v. `1`, `1.0.0`).  
- `build_id` – game build/patchversie.  
- `checksum` – eenvoudige hash over kernvelden (integriteitscheck).  
- `trilogy_profile_id` – identifier voor trilogie-profiel (zie §6).

Bij laden:

- Als `schema_version` onbekend of hoger is dan de client begrijpt, wordt save in **compat-modus** geladen (zoveel mogelijk velden, rest genegeerd) of geweigerd met een duidelijke melding.

---

## 4. Save Data – top-level structuur

Conceptueel JSON-model (designlaag):

```jsonc
SaveData = {
  "meta": { ... },
  "time_state": { ... },
  "world_state": { ... },
  "player_state": { ... },
  "party_state": { ... },
  "actors_state": { ... },
  "npc_state": { ... },
  "quests_state": { ... },
  "flags_state": { ... },
  "inventory_state": { ... },
  "economy_state": { ... },
  "postgame_state": { ... },
  "ngplus_state": { ... }
}
```

De exacte schema’s komen in `savegame.schema.json`; hieronder de designinhoud.

---

## 5. Detail per subsystem

### 5.1 Meta

`meta` bevat save-gegevens die ook in Save Meta staan, plus extra’s:

- `slot_id`, `profile_id`  
- `schema_version`, `build_id`  
- `created_at`, `updated_at`, `play_time`  
- `chapter_id`, `main_story_state` (bijv. `NOT_STARTED`, `IN_PROGRESS`, `COMPLETED`)  
- `is_postgame` (bool)  
- `is_ngplus` (bool)  
- `ngplus_cycle` (0 = eerste run, 1 = NG+1, etc.)  
- `clear_count` (aantal voltooide runs op dit profiel).

### 5.2 Time State

Koppelt direct aan 3.2 & 2.2:

- `day_index` – overall dagnummer.  
- `time_of_day` – minuten sinds middernacht.  
- `season_index` – 0–3.  
- `year_index` – optioneel.  
- `last_rest_day_index` – voor bepaalde mechanics.

### 5.3 World State

Beschrijft wereldstructuur en grote locks:

- `current_zone_id`  
- `player_position`: `{ "x": int, "y": int }` (tile-coördinaten in huidige zone)  
- `unlocked_regions`: lijst van `region_id`s.  
- `discovered_zones`: lijst van `zone_id`s (voor map/fast travel).  
- `fast_travel_points_unlocked`: lijst van fast-travel targets.  
- `environment_flags`: b.v. `shrine_restored_x`, `bridge_repaired`, `village_rebuilt`.  
- `active_events`: actieve wereld-events die over meerdere scenes lopen.

### 5.4 Player State

Protagonist-gerelateerde runtime-state:

- `active_scene_type` – `OVERWORLD`, `BATTLE`, `MENU`, `CUTSCENE`, etc.  
- `active_overworld_anchor` – bijv. laatste spawnpoint/inn.  
- `protagonist_id` – verwijzing naar actor in `actors_state`.  
- `camera_state` (optioneel) – zoom, pan-offsets (meer voor polish/debug).

### 5.5 Party State

Koppelt aan 3.3 NPC & Party Spec:

- `active_party`: lijst van `actor_id`s (volgorde = formatie).  
- `reserve_pool`: lijst van `actor_id`s (gerekruteerd, niet actief).  
- `guest_party`: lijst van tijdelijke gasten (S-/B-tier NPC’s).  
- `circle_state`:
  - `circle_unlocked` (bool)  
  - `circle_locations`: lijst van hubs waar Circle-functionaliteit beschikbaar is.  
  - optioneel `circle_level` / uitbreidingsstatus.

### 5.6 Actors State (speelbare chars & belangrijke NPC’s)

Voor alle **speelbare en trilogie-relevante NPC’s** (A-tier, sommige S-/B-tier):

Per `actor_id`:

- **Identiteit & status**  
  - `actor_id`, `name_id`  
  - `is_alive` (voor story-events), `is_available` (kan mee in party)  
  - `tier` (Base/Advanced/Ascended)  
  - `tri_profile`: `phys`, `ment`, `spir` (weights)  

- **Progression**  
  - `level`, `current_xp`  
  - `body_score`, `mind_score`, `spirit_score`  
  - combatstats (STR, END, DEF, SPD, ACC, FOC, INS, WILL, MAG, PRA, RES, DEV, etc.)

- **Skills & loadout**  
  - `learned_skills`: lijst van `skill_id`s.  
  - `equipped_skills`: lijst van `skill_id`s in slots.  

- **Gear**  
  - `weapon_id`, `offhand_id`, `armor_id`, `accessory_slot1_id`, `accessory_slot2_id`.

- **Relaties & arcs (optioneel voor trilogie)**  
  - `relationship_scores` (met andere key-actors).  
  - `personal_arc_flags`: b.v. stage van hun companion arc.

Niet alle NPC’s hoeven volledig uitgewerkt te zijn; C/D-tier kan in `npc_state` i.p.v. hier.

### 5.7 NPC State (wereld-NPC’s)

Voor brede wereldcast (incl. companions vanuit 2.3/3.3):

Per `npc_id`:

- `phase` – `SEED`, `COMPANION`, `SETTLED`, `EPILOGUE`, etc.  
- `recruited` (bool)  
- `settlement_location_id` – hub/zone waar ze zijn neergestreken.  
- `current_zone_id` & `current_schedule_id` (optioneel, kan bij reload herberekend worden op basis van TimeState).  
- `offers_service`: lijst (shop_id, trainer_id, ritual_id) indien van toepassing.

### 5.8 Quests State

Per `quest_id`:

- `state` – `NOT_DISCOVERED`, `DISCOVERED`, `ACTIVE`, `COMPLETED_SUCCESS`, `COMPLETED_FAIL`, `EXPIRED`, `ABANDONED`.  
- `current_stage_id`  
- `stage_progress_data` – optioneel key/value-map met subprogress (b.v. aantal items verzameld).  
- `timestamp_started`, `timestamp_completed` (optioneel).  
- `flags` specifiek voor die quest (bepaalde keuzes gemaakt binnen de quest).

### 5.9 Flags State

Globale, systeembrede flags:

- `story_flags` – lijst/set van booleans bij `flag_id`s (b.v. `met_guru_x`, `ch1_ritual_completed`).  
- `choice_history` – lijst van belangrijke keuzes, bijv. `choice_id -> outcome`.  
- `karma_state` – struct met verschillende assen (indien gebruikt):  
  - b.v. `compassion_vs_severity`, `tradition_vs_innovation`, etc.  
- `tutorial_flags` – welke tutorials al getoond zijn.

### 5.10 Inventory State

Beschrijft inventaris en equipped key-items:

- `items`: lijst entries  
  - `item_id`, `quantity`  
- `key_items`: lijst `item_id`s  
- `quest_items`: lijst `item_id`s  
- `chests_opened`: lijst `chest_id`s  
- `special_collections`: per collectable-type arrays, b.v.:  
  - `shrines_cleansed`, `lore_stones_found`, `viewpoints_discovered`.

### 5.11 Economy State

- `currency_amount` – huidige Rūpa.  
- `shop_states` – per `shop_id`:
  - `inventory_overrides` (bij limited stock)  
  - `last_refresh_day_index` (voor daily/periodic refresh)  
  - `shop_flags` (b.v. discount-unlocks, speciale uitgespeelde dialogs).

### 5.12 Post-game State

Koppelt naar 3.7 Post-game Spec:

- `postgame_unlocked` (bool)  
- `tri_high_trials_completed`: Body/Mind/Spirit-high trials flags.  
- `superbosses_defeated`: lijst `boss_id`s.  
- `pg_companion_epilogues_seen`: lijst `npc_id`s.  
- `festivals_completed`: lijst `festival_id`s die minstens één keer post-game zijn meegemaakt.  
- `collectables_completion`: per regio, samenvatting (bijv. percent complete of tellers).

### 5.13 NG+ State

Voor NG+-runs:

- `ngplus_cycle` – 0,1,2...  
- `ngplus_origin_slot` – verwijzing naar oorspronkelijke Clear Save.  
- `ngplus_carry_over` – samenvatting van wat is meegenomen (levels, Tri-scores, skills, gear-IDs).  
- `ngplus_modifiers`: lijst van actieve NG+-instellingen (b.v. hogere enemy stats, extra drops, extra NG+-quests).

---

## 6. Trilogy Continuity – Exportprofiel

### 6.1 Concept

Naast de volledige save definieert het spel een **Trilogy Export Profile**:

- Een **compacte, gestabiliseerde samenvatting** van de belangrijkste keuzes en progressie in deel 1.  
- Bedoeld om door deel 2/3 ingelezen te worden zonder dat zij de volledige interne save-structuur hoeven te begrijpen.

Dit profiel kan:

- In de Clear Save worden opgenomen.  
- Als los JSON-bestand geëxporteerd worden (optioneel UI-feature).

### 6.2 Inhoud Trilogy Export Profile

Globale structuur (conceptueel):

```jsonc
TrilogyProfile = {
  "trilogy_profile_id": "...",
  "game_id": "tri_sarira_rpg_1",
  "schema_version": 1,
  "summary": { ... },
  "story_outcomes": { ... },
  "companions": { ... },
  "world_outcomes": { ... },
  "progression_summary": { ... },
  "trials_and_bosses": { ... },
  "karma_and_themes": { ... }
}
```

#### 6.2.1 Summary

- `protagonist_name`  
- `play_time`  
- `clear_count`  
- `ngplus_cycle`  
- Globale difficulty-indicator (bijv. of speler veel post-game heeft gedaan).

#### 6.2.2 Story outcomes

Belangrijkste hoofdverhaallijnen:

- `main_story_state` (COMPLETED/INCOMPLETE).  
- `ending_variant_id` – welk einde (als er meerdere zijn).  
- Key-choices: lijst `choice_id -> outcome_id` voor cruciale verhaalsplitsingen.

#### 6.2.3 Companions

Per belangrijke companion (`npc_id`):

- `recruited`  
- `final_phase` – COMPANION/SETTLED/EPILOGUE/DECEASED.  
- `epilogue_state_id` – welke epiloogvariant.  
- `relationship_score_summary` (optioneel bucket: low/med/high).

#### 6.2.4 World outcomes

Per regio/world-arc:

- `region_id` -> `state_id` (bijv. herbouwd, bevrijd, gedeeltelijk, mislukt).  
- Special flags (bv. `forest_corruption_cleansed`, `temple_restored`).

#### 6.2.5 Progression summary

Voor protagonist (en eventueel 1–2 kerncompanions):

- `level`  
- `tri_profile`  
- `body/mind/spirit_scores` (geclusterd in ranges)  
- `dominant_role` (b.v. Body-frontliner, Mind-controller, Spirit-caster).  
- Lijst van **key_skills** (niet alle minor skills).

#### 6.2.6 Trials & bosses

- `tri_high_trials_completed`: Body/Mind/Spirit.  
- `superbosses_defeated`: lijst of tellers.  
- `postgame_completion_level`: rough indicator (none / light / medium / deep).

#### 6.2.7 Karma & thematische as

Samenvatting van karmische en thematische balans (optioneel):

- `karma_axes`: waarden per as, eventueel in discrete buckets.  
- `dominant_theme`/`path` – b.v. "streng maar rechtvaardig", "compassievol verzoener".

### 6.3 Canonkeuze

Omdat een speler meerdere runs kan hebben (NG+, alternatieve saves), moet er een manier zijn om een **canon-profiel** te kiezen:

- Standaard: laatste Clear Save wordt voorgesteld.  
- Optioneel: UI waarin speler zelf kiest welke Clear Save / Trilogy Profile canon is voor deel 2.

De `trilogy_profile_id` wordt dan bewaard en door deel 2 gebruikt.

---

## 7. Vertical Slice vs. volledige game

### 7.1 Vertical Slice (M2)

Voor de slice is een **sterk beperkte subset** nodig:

- `meta`: basic slot/meta-info, chapter_id, play_time.  
- `time_state`: day_index, time_of_day (vereenvoudigd).  
- `world_state`: current_zone_id, player_position, unlocked/discovered zones (R1).  
- `party_state`: active_party, reserve_pool (max 2 chars).  
- `actors_state`: level, xp, stats, skills, gear voor MC (+ evt. 1 companion).  
- `quests_state`: paar quests met state + current_stage.  
- `inventory_state`: items, chests_opened, currency.  
- Geen volwaardige post-game/NG+-structuur nodig; hooguit enkele placeholder-velden.

Trilogy Export Profile is **niet nodig** in de slice; mag als design-document blijven bestaan.

### 7.2 Volledige game

- Volledige implementatie van alle hierboven beschreven velden.  
- Tools voor **migration** van oude saves (b.v. V1 → V2 schema).  
- Export/import van Trilogy Profiles.

---

## 8. Data & schema-koppeling

Belangrijkste schema’s en bestanden:

- **`savegame.schema.json`** – formele definitie van SaveData.  
- **`save_meta.schema.json`** – optioneel, afgeslankt schema voor slotweergave.  
- **`trilogy_profile.schema.json`** – definieert Trilogy Export Profile.

Deze schema’s verwijzen door naar:

- `actors.schema.json` – structuur van actor/character-entries.  
- `items.schema.json` – referenties naar item-IDs in inventory/gear.  
- `skills.schema.json` – referenties naar skill-IDs.  
- `quests.schema.json` – referenties naar quests & stages.  
- `zones.schema.json`, `events.schema.json`, `npc_schedules.schema.json` – wereld- en NPC-data.

---

## 9. Relatie met andere artefacten

- **Scenes & State Flow – Tri-Śarīra RPG** – bepaalt welke scene verantwoordelijk is voor het opslaan/updaten van welke substate.  
- **3.1 Combat & Stats / 3.5 Progression & Leveling** – leveren de stat- en progression-data die we per actor bewaren.  
- **3.2 Time, World & Overworld** – levert zones, TimeState en world flags die in `world_state` en `time_state` zitten.  
- **3.3 NPC & Party System** – definieert party-, NPC- en Circle-structuur.  
- **3.4 Quests & Dialogue System** – definieert `quests_state`, `flags_state` en dialogue-driven keuzes.  
- **3.6 Items, Gear & Economy** – bepaalt inventory-, gear- en economy-structuur.  
- **3.7 Post-game & NG+** – definieert `postgame_state` en `ngplus_state` use-cases.  
- **1.x Vision/Baseline/Roadmap** – bepalen hoe lang de campagne is en welke trilogie-ambities de continuïteit sturen.

Versie 0.1 legt de **kapstok** vast voor save en trilogie. Concrete schema’s, tools voor migratie en het precieze keuze-lijstje voor Trilogy Profiles komen in latere design- en implementatiefases.