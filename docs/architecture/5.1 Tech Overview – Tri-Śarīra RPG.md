# 5.1 Tech Overview – Tri-Śarīra RPG

**Versie:** 0.1  
**Auteur:** Gerald (met Architect- & Game Designer-ondersteuning)  
**Status:** Tech design-overzicht. Richtlijnen voor stack, runtime, architecturale stijl en ontwikkelworkflow.

Doel: een **compact maar compleet technisch beeld** neerzetten, zodat:

- jij zelf snapt *hoe* de game technisch in elkaar steekt,  
- Codex / Claude Code / andere dev-AI’s **consistent** kunnen bouwen,  
- de rest van 5.x (architectuur, folders, guidelines, run/build) hier logisch op aansluit.

---

## 1. Doelplatform & scope

### 1.1 Doelplatform

- **Primary:** Desktop (Windows 11 + WSL-omgeving, Linux), single-player.  
- **Engine-layer:** Eigen 2D-engine op basis van **Pygame** (top-down tile-based overworld + turn-based battles).  
- **Resolutie:** Pixel-art, gefixeerde interne resolutie met scaling (bijv. 640×360 → opgeschaald naar 1280×720 of 1920×1080).

Geen console/mobile support in v1; alles is geoptimaliseerd voor **lokaal spelen en ontwikkelen**.

### 1.2 Game-scope vs tech-scope

- Game-scope: lange RPG (100h main + 50h side, trilogie-ambitie).  
- Tech-scope voor nu:  
  - **Vertical slice** (A2) van **R1 / Chandrapur** + eerste route + eerste shrine,  
  - met alle kernsystemen aanwezig in light-vorm: overworld, battles, NPC’s, quests, tijd/dag-nacht, items, saves.

De tech moet **schalen** naar volledige game zonder later alles te moeten herschrijven.

---

## 2. Taal, runtime & dependencies

### 2.1 Taal & runtime

- **Taal:** Python  
- **Doelversie:** Python 3.12+ (minimaal 3.11, maar richten op up-to-date stack).  
- **Interpreter:** CPython; geen speciale variant nodig.

### 2.2 Kern-dependencies (runtime)

- **Pygame** – rendering, input, audio, main-loop.  
- **Standard library** – `json`, `logging`, `pathlib`, `dataclasses`, etc.  
- Optioneel/light:  
  - `tomllib` of derde lib voor config (indien je TOML gebruikt).  
  - kleine math/utility-libs (maar liever minimalistisch en standaardlib-focussed).

Geen zware frameworks (geen Django/Flask, geen grote ECS-libs) – focus op **lichte, leesbare architectuur**.

### 2.3 Dev-dependencies

- **Formatter:** `black` (of `ruff` met formatter).  
- **Linter:** `ruff`.  
- **Type-checker:** `mypy` (light gebruik, vooral voor core systemen).  
- **Testframework:** `pytest`.  
- **Pre-commit:** optioneel, maar aanbevolen voor formatter/linter-hooks.

Deze worden in 5.4 (Coding Guidelines) en `pyproject.toml` verder gespecificeerd.

---

## 3. Architecturale stijl & hoofdlijnen

### 3.1 Architectuurstijl

- **Layered + feature-based**: scheiding tussen engine-layer, systems-layer en content/data.
- **Data-driven**: gamecontent (actors, enemies, items, skills, quests, dialogue, maps, events) wordt in JSON/Tiled opgeslagen, niet hardcoded.
- **Scene-based**: een centrale `SceneStackManager` (via `SceneManagerProtocol`) stuurt welke Scene actief is (`MainMenu`, `OverworldScene`, `BattleScene`, etc.).
- **Protocol-based Dependency Injection**: systems communiceren via Protocols (abstracte interfaces), niet via concrete classes. Dit zorgt voor loose coupling en eenvoudige testing.
- **ViewModel-patroon**: systems leveren immutable viewmodels aan de UI; de presentation layer heeft geen directe toegang tot interne system state.
- **Service-laag**: een `GameDataService` fungeert als facade tussen UI en data-access, met typed view models.

### 3.2 Hoofdcomponenten

1. **Core/Engine**  
   - Main loop (tijd, input, update, render).  
   - Window en graphics-handling (Pygame init, surfaces, scaling).  
   - Input mapping (keyboard/controller → acties).  
   - SceneManager + abstracte `Scene`-baseclass.

2. **Systems-layer** (game logica, grotendeels engine-onafhankelijk):  
   - **World / Overworld** – tilemap, collision, entities, camera.  
   - **Combat** – turn-order, actions, damage, status, UI voor gevecht.  
   - **NPC & Party** – party-samenstelling, companions, NPC-phases.  
   - **Quests & Dialogue** – queststate, branching dialogue, flags.  
   - **Time & Calendar** – dag/nacht, seizoenen, festivals.  
   - **Items, Gear & Economy** – inventory, shops, loot.  
   - **Progression & Save** – XP, level-ups, save/load, NG+/post-game flags.

3. **Data & content**  
   - JSON-data (`data/*.json`) plus schema’s (`schema/*.schema.json`) voor validatie.  
   - Tiled-maps (`maps/*.tmx` + `assets/tilesets/*.tsx`).  
   - Assets (sprites, audio) georganiseerd per feature/zone waar mogelijk.

4. **Glue & UI**  
   - UI-widgets (menus, dialogue-boxen, combat UI) bovenop Pygame.  
   - Binding tussen Scene-events en Systems (bijv. `OverworldScene` roept `QuestSystem` aan bij interactie).

### 3.3 State & Scenes (koppeling met Scenes & State Flow)

- Eén centrale `Game` of `App`-klasse initialiseert:  
  - `Config`,  
  - `ResourceManager` (assets),  
  - `DataRepository` (JSON-data),  
  - Systems (World, Combat, Quests, Time,…)  
  - SceneManager.

- Scenes wisselen via expliciete calls, bv.:  
  - `MainMenuScene` → `OverworldScene` (start nieuw spel).  
  - `OverworldScene` → `BattleScene` (enemy encounter).  
  - `BattleScene` → terug naar `OverworldScene` (resultaat gevecht).  
  - `OverworldScene` → `DialogueScene` (NPC-interactie) → terug.

Belangrijk: **systems houden de state** (party, quests, flags), Scenes zijn vooral **weergave + input-flow**.

---

## 4. Data & assets – bron van waarheid

### 4.1 JSON-data

- Kernbestanden onder `data/` (zie 4.x artefacten):  
  - `actors.json`, `enemies.json`, `items.json`, `skills.json`,  
  - `quests.json`, `dialogue.json`,  
  - `npc_schedules.json`, `events.json`,  
  - `shops.json`, `loot_tables.json`, `chests.json`,  
  - `zones.json` (light zone-metadata),  
  - `savegame`-export (runtime).

- Conform `schema/*.schema.json` (JSON Schema).  
- Runtime gebruikt één `DataRepository` om geladen data aan systems te leveren (met caches).

### 4.2 Tiled-maps & tilesets

- `maps/*.tmx` per `zone_id` (zie 4.3 Tiled Conventions).  
- `assets/tilesets/*.tsx` gedeeld tussen maps.  
- Mapproperties (`zone_id`, `zone_type`, `recommended_level`, `encounter_table_id_default`, etc.)  
- Objectlayers: `Spawns`, `Portals`, `Chests`, `Events`, `EncounterRegions`, `Markers`.

### 4.3 Sprites & audio

- **Sprites**:  
  - `assets/sprites/characters/` – per actor/NPC.  
  - `assets/sprites/enemies/` – per enemy-type.  
  - `assets/sprites/ui/` – UI-elementen (hp-bars, icons).  
- **Audio**:  
  - `assets/audio/bgm/` – muziek per zone/scene.  
  - `assets/audio/sfx/` – effecten (hit, menu, confirm).  

Assets zijn **niet** de focus van deze spec, maar folderstructuur sluit aan op 5.3 Folder & Module-structuur.

---

## 5. Configuratie & omgevingen

### 5.1 Config

Één centrale config-laag voor:

- **Padinstellingen** – waar data- en assetfolders staan.  
- **Game settings** – resolutie, fullscreen/windowed, audio-volume, input-mapping.  
- **Debug-dev toggles** – b.v. skip intro, god-mode (voor test), fps overlay.

Implementatie (aanbevolen):

- `config/default_config.toml` – standaardwaarden.  
- `config/dev.toml` – dev overrides (niet voor release).  
- Kleine `Config`-klasse die dit samenvoegt.

### 5.2 Omgevingen

- **Dev build:**  
  - logging op `DEBUG`, extra asserts, hot-reload van data waar mogelijk (herladen JSON zonder herstart).  
- **Release build:**  
  - logging op `INFO`/`WARN`, geen dev-shortcuts, data mogelijk gecomprimeerd/gekopieerd.

---

## 6. Logging, fouten & debug

### 6.1 Logging

- Python `logging` met basisconfig:
  - Log-level configureerbaar (`DEBUG` in dev).  
  - Log naar console + optioneel file (`logs/game.log`).

Gebruik:

- Systems loggen belangrijke acties (queststart, zone-change, save/load, errors in data).  
- Scenes beperken zich tot high-level transitions.

### 6.2 Error-handling

- Data-loadfase:  
  - schema-validatie → duidelijke foutmelding welk bestand/veld faalt.  
  - abort start als kritieke data ontbreekt/corrupt is.

- Runtime:  
  - bij ontbrekende referenties (item_id, quest_id) → log error + veilige fallback (geen crash tijdens spelen als het even kan).

### 6.3 Debug-hulpmiddelen (later)

- In-game debug overlay (fps, zone_id, tile coords).  
- Mogelijkheid om **teleport** of **quest force advance** te gebruiken in dev-mode.

---

## 7. Testen & kwaliteitsbewaking

### 7.1 Unit & integration tests

- **Unit tests** vooral voor systems:  
  - Combat-calculaties, damage, status.  
  - Quest-state-transitions gegeven events/flags.  
  - Save/load roundtrips.

- **Integration tests** light:  
  - laden van alle data-bestanden.  
  - checken op broken refs (item_id/quest_id/zone_id) – kan ook via eigen script.

### 7.2 Data-validatie

- CLI-tool/script:  
  - `python -m tools.validate_data` →  
    - JSON Schema-validatie,  
    - referential integrity checks (IDs),  
    - rapport per bestand.

Deze stap hoort in de standaard **build/test pipeline** (zie 5.5 Run & Build).

---

## 8. Vertical Slice – tech-focus

Voor de vertical slice (A2) is de tech nodig die:

1. **Game boot + SceneManager**  
   - Start in `MainMenuScene` → `OverworldScene` voor R1.

2. **Overworld-engine**  
   - Tiled-map laden, collision, camera, basic interaction (NPC aanspreken, chest openen, portal gebruiken).  
   - Random encounter triggers op `z_r1_forest_route`.

3. **Battle-engine (light)**  
   - Turn-based gevecht met MC + 1 companion vs 1–3 enemies.  
   - Basic skills, damage, victory/defeat-flow terug naar overworld.

4. **NPC & Dialogue**  
   - NPC’s zichtbaar op map volgens schedule (simple variant).  
   - Dialoog UI + keuzes, queststart/advance via dialogue.

5. **Quests & Flags**  
   - 1–2 main quests (`q_r1_001_shrine_intro` + evt. 1 side).  
   - Quest-log en state-opslag.

6. **Items & Shops**  
   - Inventory UI, consumables gebruiken in/buiten battle (light),  
   - Basic shop in Chandrapur.

7. **Save/Load (light)**  
   - Manual save op specifieke punten (inn/shrine).  
   - Laden via simpel menuslot.

8. **Time & Day/Night (light)**  
   - Dag-nacht verandering visueel (kleurfilter) + simpele impact op encounters of NPC-aanwezigheid.

Full post-game/NG+/trilogie hoeft nog niet; wel moet de architectuur ze later makkelijk kunnen toevoegen (wat in 3.7 / 3.8 al voorbereid is).

---

## 9. Relatie met andere artefacten

- **5.2 Architectuur-overzicht (light)**  
  - Tekent de concrete modules, klassen en dependencypijlen op basis van dit Tech Overview.

- **5.3 Folder- & Module-structuur**  
  - Legt de daadwerkelijke layout van `src/`, `data/`, `assets/`, `tools/` vast.

- **5.4 Coding Guidelines**  
  - Maakt afspraken over Python-stijl, logging, errorhandling, tests.

- **5.5 Run- & Build-instructies**  
  - Beschrijft hoe je in jouw omgeving (Windows + WSL) de game runt, data valideert en een distributable build maakt.

- **3.x Systems-specs + 4.x Data/Schema’s**  
  - Bepalen welke modules/systems er concreet nodig zijn en welke data ze gebruiken.

Versie 0.1 dient als **kapstok** voor alle latere techbesluiten; wijzigingen in tools/stack worden hier eerst vastgelegd en daarna doorgevoerd in de andere 5.x-artefacten.
