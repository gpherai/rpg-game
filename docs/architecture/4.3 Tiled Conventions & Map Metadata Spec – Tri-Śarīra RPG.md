# 4.3 Tiled Conventions & Map Metadata Spec – Tri-Śarīra RPG

**Versie:** 0.1  
**Auteur:** Gerald (met Game Designer- & Architect-ondersteuning)  
**Status:** Design-spec. Richt af hoe Tiled-maps worden opgezet, benoemd en verrijkt met metadata, zodat engine + data (`zones.json`, `events.json`, etc.) er consistent mee kunnen werken.

Doel:

- Afspreken **hoe we Tiled gebruiken** (layers, object-layers, properties).  
- Vastleggen van **naming conventions** voor zones, tilesets, objecten.  
- Bepalen welke **map-metadata** in Tiled staat en welke in losse JSON (`zones.json`) staat.  
- Zorgen dat Claude/Codex zonder discussie maps kan aanmaken voor vertical slice en verder.

---

## 1. Basisparameters & naamgeving

### 1.1 Tile & map-basis

- **Tilesize:** 32×32 pixels (top-down/3⁄4-perspectief).  
- **Tile grid:** orthogonal, tile-origin linksboven.  
- **Coordinate-systemen:**  
  - *Tile coords* (`x`, `y`) vanaf (0,0) linksboven.  
  - *Pixel coords* alleen relevant in rendering; game-logica werkt in tile coords.

### 1.2 Bestandsnamen & IDs

We hanteren één bron van waarheid per zone:

- **`zone_id` ↔ TMX-bestand**:  
  - `z_r<regionIndex>_<short_name>` → `maps/z_r<regionIndex>_<short_name>.tmx`  
  - Voorbeeld:  
    - `z_r1_chandrapur_town` → `maps/z_r1_chandrapur_town.tmx`  
    - `z_r1_forest_route` → `maps/z_r1_forest_route.tmx`

- **Regio’s** komen uit `region_id` (bijv. `r1_chandrapur_valley`).  
- `zone_id` wordt zowel in **Tiled properties** als in `zones.json` gebruikt.

### 1.3 Tilesets

- Tilesets liggen in `assets/tilesets/`.  
- Naamconventie:  
  - `ts_<theme>_<variant>` (bv. `ts_town_basic`, `ts_forest_r1`, `ts_interior_wood`).  
- Tiled gebruikt **extern tileset-bestand** (`.tsx`) per logische set, zodat meerdere maps dezelfde tileset kunnen gebruiken.

---

## 2. Zones & map-level properties

Elke Tiled-map (zone) bevat een set **map-properties** (Project → Properties → Custom Properties):

Verplicht:

- `zone_id` (string)  
- `region_id` (string, bv. `r1_chandrapur_valley`)  
- `zone_type` (string) – bv. `TOWN`, `ROUTE`, `WILDERNESS`, `DUNGEON`, `INTERIOR`, `SPECIAL`  
- `recommended_level` (int) – richtlijn, niet hard.

Aanbevolen:

- `encounter_table_id_default` (string | null) – default enemy-encountertable voor random encounters.  
- `bgm_id` (string | null) – background music ID.  
- `ambient_sfx_id` (string | null) – ambience (vogels, regen, markt).  
- `lighting_profile` (string | null) – bv. `DAY_SOFT`, `NIGHT_TORCHES`, `INTERIOR_WARM`.  
- `allow_random_encounters` (bool) – default `true` voor routes/wilderness; `false` voor towns/interiors.

Later / optioneel:

- `zone_flags_on_enter` (string) – JSON-string of ID naar eventset die flags zet bij eerste betreden.  
- `zone_flags_on_clear` (string) – voor zones met een “cleared” state.

**Bron van waarheid:**  
- `zones.json` houdt **list van zones** + high-level metadata bij.  
- Tiled-map properties moeten **synchroon** blijven met `zones.json`; buildtools kunnen checks doen.

---

## 3. Layer-structuur

We gebruiken een vaste **laagvolgorde** voor leesbaarheid en engine-logica.

### 3.1 Tile layers

Aanbevolen basislayers (names fixed):

1. `Ground`  
   - Basisterrein: gras, aarde, water, vloer.  
2. `Ground_Detail`  
   - Kleine details (stenen, bloemen, scheuren) die onder characters liggen.  
3. `Terrain_Cliffs` (optioneel)  
   - Kliffen, muren, hoogteverschillen.  
4. `Objects`  
   - Grote objecten waarachter de speler deels kan verdwijnen (bomen, huizen, etc.).  
5. `Objects_Top`  
   - Overhangende delen (daken, boomkronen) die **boven** de speler getekend worden.

### 3.2 Collision layer

- Speciale tile-layer: `Collision`.  
- Conventie:  
  - **Niet leeg tile** = blokkerend voor movement.  
  - Lege tile = geen collision.  
- Tileset voor collision mag een simpele 1-tile tileset zijn (onzichtbaar in spel, alleen voor Tiled); engine rendert deze layer niet.

### 3.3 Overlays & effecten

Optioneel voor latere polish:

- `Overlay_Fog` – halftransparant fog-layer.  
- `Overlay_Light` – light/shadow-masks.

Deze lagen zijn niet noodzakelijk voor vertical slice maar alvast gereserveerd.

---

## 4. Object layers & conventies

We gebruiken **Object Layers** in Tiled voor alle “logische” dingen: spawnpoints, portals, chests, triggers, etc.

### 4.1 Overzicht

Aanbevolen object-layers:

- `Spawns` – player- en NPC-spawnpoints.  
- `Portals` – zone-overgangen & deuren.  
- `Chests` – posities van kisten en vaste loot-objecten.  
- `Events` – triggers voor cutscenes, encounters, scripts.  
- `EncounterRegions` – gebieden met random encounters (optioneel).  
- `Markers` – helper-markers voor design/debug.

Engine kan layers vinden op **naam**; graag consistent houden.

---

## 5. Spawns (player & NPC)

**Object layer:** `Spawns`

### 5.1 Player spawns

- Object type: `PlayerSpawn`  
- Naamconventie: `spawn_<label>` – bv. `spawn_default`, `spawn_inn_room`, `spawn_from_route`.  
- Object-properties:
  - `spawn_id` (string, verplicht) – matcht `active_overworld_anchor`/portal-targets.  
  - `is_default` (bool, optioneel) – welke spawn gebruikt wordt als er geen specifieke target is.

Engine gebruikt `spawn_id` om bij zone-wissel te bepalen waar de speler verschijnt.

### 5.2 NPC spawns

- Object type: `NPCSpawn`  
- Naamconventie: `npc_<npc_id>`.  
- Object-properties:
  - `npc_id` (string) – matcht NPC in `npc_schedules.json`.  
  - `initial_phase` (string, optioneel) – default phase bij eerste load.

In v1 mogen NPC-coördinaten direct uit `npc_schedules.json` komen; deze spawn-objecten zijn dan vooral handig voor **designvisualisatie** of fallback-positie.

---

## 6. Portals & zone-overgangen

**Object layer:** `Portals`

### 6.1 Portal-objects

- Object type: `Portal`  
- Vorm: rectangle (1 tile of meerdere tiles)  
- Naamconventie: `portal_<from>_to_<zone>` – bv. `portal_town_to_route`.

Properties:

- `target_zone_id` (string) – bv. `z_r1_forest_route`.  
- `target_spawn_id` (string) – bv. `spawn_from_town`.  
- `direction_hint` (string, optioneel) – `N`, `E`, `S`, `W` (hoe de speler bij aankomst kijkt).  
- `conditions` (string, optioneel) – ID naar een condition-set in data, bv. slot vereist.

Engine logica:

- Bij overlap met Portal + input (of automatisch, afhankelijk van type) → switch naar `target_zone_id` en plaats speler op `target_spawn_id`.

---

## 7. Chests & vaste loot

**Object layer:** `Chests`

### 7.1 Chest-objects

- Object type: `Chest`  
- Vorm: rectangle (1 tile)  
- Naamconventie: `ch_<zoneShort>_<index>` – bv. `ch_r1_town_01`.

Properties:

- `chest_id` (string) – **exacte match** met ID in `chests.json`.  
- Optioneel: `is_hidden` (bool) – voor secret chests.

Engine gebruikt de positie uit Tiled, maar **loot** en one-time logica uit `chests.json` + `savegame` (`chests_opened`).

---

## 8. Events & triggers

**Object layer:** `Events`

### 8.1 Event-objects

- Object type: `EventTrigger`  
- Naamconventie: `ev_<short_descr>` – bv. `ev_shrine_guardian_intro`.  
- Vorm: rectangle (collision-gebied) of punt.

Properties:

- `event_id` (string) – matcht entry in `events.json`.  
- `trigger_type` (string):  
  - `"ON_ENTER"` – zodra speler het gebied betreedt.  
  - `"ON_INTERACT"` – pas bij interact-button.  
  - `"ON_STEP"` – elke stap, totdat event zichzelf uit zet.  
- `once_per_save` (bool) – true voor cutscenes etc.  
- `once_per_day` (bool, optioneel) – herhaalbaar per dag (bv. kleine flavour-events).

Engine ziet Tiled vooral als **locatie-definitie**; logica (wat er gebeurt) komt uit `events.json`.

---

## 9. Encounter-regio’s

**Object layer:** `EncounterRegions` (optioneel, vooral voor routes/dungeons)

### 9.1 Encounter-region objects

- Object type: `EncounterRegion`  
- Vorm: rectangle of polygon die gebied afbakent.  
- Naamconventie: `enc_<zoneShort>_<index>`.

Properties:

- `encounter_table_id` (string) – bv. `et_r1_forest_route_day`.  
- `allow_random_encounters` (bool) – override van map-level default.  
- `step_min` (int) – min aantal stappen tussen encounters.  
- `step_max` (int) – max aantal stappen tussen encounters.

Engine logica:

- Bij elke stap kijkt de overworld-controller welke EncounterRegion(s) gelden → gebruikt hun settings i.p.v. `encounter_table_id_default` op map.

---

## 10. Markers & debug

**Object layer:** `Markers`

- Vrije layer voor **ontwerpannotaties** (niet in release build nodig).  
- Voorbeeld:  
  - `marker_type` = `VIEWPOINT`, `SHRINE_CORE`, `BOSS_ENTRY`, etc.  
- Kaarten kunnen hiermee handiger besproken worden, maar engine negeert deze layer in runtime.

---

## 11. Shrine- & Tri-Śarīra-specifieke markers

Voor shrines, rituele plekken en Tri-specifieke gameplay gebruiken we óf `Markers` óf splitsen we later nog uit naar een aparte layer.

Voor nu (spec v0.1):

- Plaats een object op `Markers` met:  
  - `marker_type`: `SHRINE_CORE`  
  - `shrine_id`: string – matcht shrine-entry in toekomstige `shrines.json` / `events.json`.  
- De daadwerkelijke interactie en effecten (rituelen, Tri-Trials, etc.) lopen via `events.json`.

Later kan dit opgesplitst worden in een eigen layer `Shrines` als dat overzichtelijker wordt.

---

## 12. Vertical Slice – minimale afspraken

Voor de **vertical slice (R1 / Chandrapur + eerste route + eerste shrine)** is het volgende minimaal nodig:

- **Maps:**  
  - `z_r1_chandrapur_town.tmx`  
  - `z_r1_training_ground.tmx` (optioneel)  
  - `z_r1_forest_route.tmx`  
  - `z_r1_shrine_clearing.tmx`  
  - `z_r1_shrine_inner.tmx` (optioneel, mini-interior)

- **Layers per map:**  
  - `Ground`, `Ground_Detail`, `Objects`, `Objects_Top`, `Collision`.  

- **Object-layers per map (minimaal):**  
  - `Spawns`: ten minste één `PlayerSpawn` per zone.  
  - `Portals`: town ↔ route, route ↔ shrine, etc.  
  - `Chests`: 1–2 chests volgens `chests_example.json`.  
  - `Events`: triggers voor shrine-battle (`ev_start_shrine_battle`) en evt. kleine cutscenes.  
  - `EncounterRegions`: alleen op `z_r1_forest_route` (met tafel `lt_r1_forest_minions`).

- **Map-properties:**  
  - `zone_id`, `region_id`, `zone_type`, `recommended_level`.  
  - Voor route/shrine: `encounter_table_id_default`, `allow_random_encounters = true`.  
  - Voor town/interiors: `allow_random_encounters = false`.

Met deze set kan de engine:

- Speler spawnen en tussen zones teleporteren.  
- Collision correct afhandelen.  
- Random encounters op de route/delen van de shrine starten.  
- Chests & events positioneren.  
- Later vrij eenvoudig extra NPC’s en events laten landen.

---

## 13. Volledige game – uitbreidingen

Voor latere regio’s en post-game:

- Meer gebruik van `EncounterRegions` met seizoensgebonden encounter tables.  
- Festival-specifieke Events (tijdgebonden triggers op town-maps).  
- Markers voor **viewpoints/landmarks**, shrines en bijzondere Tri-challenge-locaties.  
- Eventueel aparte layers voor **interactables** (pots, doors, switches) met object-type `Interactable`.

---

## 14. Relatie met andere artefacten

- **Scenes & State Flow – Tri-Śarīra RPG**  
  - Bepaalt welke Scene `Portals`, `Events`, random encounters, etc. verwerkt.  
- **3.2 Time, World & Overworld Spec**  
  - Definieert zones, fast travel, encounter-logica; Tiled levert de **ruimtelijke kant**.  
- **3.1 Combat & Stats / 3.6 Items, Gear & Economy**  
  - Gebruiken enemy- en loot-data gekoppeld aan encounter-regio’s die in Tiled staan.  
- **3.3 NPC & Party System Spec / 2.3 NPC Cast & Fasen**  
  - NPC-schedules koppelen `npc_id` + `zone_id` + (optioneel) Tiled-markers.  
- **4.1 JSON-schema’s**  
  - `zones.schema.json`, `events.schema.json`, `npc_schedules.schema.json`, `chests.schema.json`, etc. refereren allemaal naar `zone_id` en objecten die in Tiled gepositioneerd zijn.

Versie 0.1 geeft de **basisafspraken** zodat leveldesign in Tiled direct bruikbaar is voor de vertical slice én schaalbaar blijft naar de volledige game en trilogie.

